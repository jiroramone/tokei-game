<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時計ゲーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .game-container {
            width: 100%;
            max-width: 600px;
            text-align: center;
            background-color: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
        }
        
        .level-selection {
            margin: 20px 0;
        }

        .level-btn {
            font-size: 1.125rem;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 12px;
            margin: 0 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15);
        }

        .level-1-btn { background-color: #a7f3d0; color: #065f46; }
        .level-2-btn { background-color: #fde68a; color: #b45309; }
        .level-3-btn { background-color: #bfdbfe; color: #1e40af; }

        .game-controls {
            margin-top: 20px;
        }

        #prompt {
            font-size: 1.5rem;
            font-weight: 700;
            min-height: 48px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        #feedback {
            font-size: 1.5rem;
            font-weight: 700;
            min-height: 48px;
            margin-top: 20px;
        }

        #feedback.correct { color: #10b981; }
        #feedback.incorrect { color: #ef4444; }

        .answer-buttons button {
            font-size: 1.25rem;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 12px;
            font-weight: 600;
            background-color: #e5e7eb;
            color: #374151;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .answer-buttons button:hover {
            background-color: #d1d5db;
            transform: translateY(-2px);
        }
        
        #next-round-btn, #submit-btn {
            padding: 12px 24px;
            font-size: 1.25rem;
            font-weight: 600;
            background-color: #4f46e5;
            color: white;
            border-radius: 12px;
            margin-top: 16px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        #next-round-btn:hover, #submit-btn:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
        }

        canvas {
            display: block;
            margin: 0 auto;
            border: 4px solid #3b82f6;
            border-radius: 50%;
            background-color: #f9fafb;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06), 0 0 0 10px #e5e7eb;
        }
    </style>
</head>
<body>

<div class="game-container">
    <h1 class="text-3xl md:text-4xl">時計ゲーム</h1>
    <p class="text-gray-500 mb-4">レベルを選択してください</p>

    <div class="level-selection flex justify-center flex-wrap">
        <button id="start-level-1" class="level-btn level-1-btn">レベル1 (何時)</button>
        <button id="start-level-2" class="level-btn level-2-btn">レベル2 (5分刻み)</button>
        <button id="start-level-3" class="level-btn level-3-btn">レベル3 (針合わせ)</button>
    </div>

    <div class="game-area">
        <div id="prompt" class="text-2xl font-bold text-gray-700 my-4"></div>
        <canvas id="clockCanvas" width="300" height="300"></canvas>
        <div id="feedback" class="text-xl font-bold mt-4"></div>
        
        <div id="answer-options" class="answer-buttons mt-4 flex flex-wrap justify-center"></div>

        <div id="game-controls" class="game-controls flex justify-center">
            <button id="submit-btn" style="display:none;">回答</button>
            <button id="next-round-btn" style="display:none;">次の問題</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('clockCanvas');
        const ctx = canvas.getContext('2d');
        const promptEl = document.getElementById('prompt');
        const feedbackEl = document.getElementById('feedback');
        const answerOptionsEl = document.getElementById('answer-options');
        const submitBtn = document.getElementById('submit-btn');
        const nextRoundBtn = document.getElementById('next-round-btn');

        // レベル選択ボタンのイベントリスナー
        document.getElementById('start-level-1').addEventListener('click', () => startGame(1));
        document.getElementById('start-level-2').addEventListener('click', () => startGame(2));
        document.getElementById('start-level-3').addEventListener('click', () => startGame(3));

        let level = 0;
        let targetTime = { hour: 0, minute: 0 };
        let currentHour = 0;
        let currentMinute = 0;
        let handBeingDragged = null; // 'hour' or 'minute'
        let mouseIsDown = false;
        const handSensitivity = 0.5; // 針の感度を低めに設定

        const clockCenterX = canvas.width / 2;
        const clockCenterY = canvas.height / 2;
        const clockRadius = canvas.width / 2 * 0.85;

        // ゲームの初期化と開始
        function startGame(newLevel) {
            level = newLevel;
            feedbackEl.textContent = '';
            answerOptionsEl.innerHTML = '';
            submitBtn.style.display = 'none';
            nextRoundBtn.style.display = 'none';

            // レベル1と2のゲーム開始
            if (level === 1 || level === 2) {
                generateTargetTime();
                promptEl.textContent = 'この時計は何時ですか？';
                drawClock(targetTime.hour, targetTime.minute);
                createAnswerButtons();
            }
            // レベル3のゲーム開始
            else if (level === 3) {
                generateTargetTime();
                promptEl.textContent = `針を動かしてこの時間に合わせてください: ${targetTime.hour}時${targetTime.minute}分`;
                currentHour = 6;
                currentMinute = 30;
                drawClock(currentHour, currentMinute);
                submitBtn.style.display = 'block';
            }
        }

        // 正解時間をランダムに生成
        function generateTargetTime() {
            const hour = Math.floor(Math.random() * 12) + 1;
            let minute;

            if (level === 1) {
                minute = 0;
            } else {
                minute = Math.floor(Math.random() * 12) * 5;
            }
            targetTime = { hour, minute };
        }

        // レベル1と2の回答ボタンを生成
        function createAnswerButtons() {
            const correctTimeStr = `${targetTime.hour}時${targetTime.minute}分`;
            const options = new Set();
            options.add(correctTimeStr);

            while (options.size < 4) {
                let distractorHour = Math.floor(Math.random() * 12) + 1;
                let distractorMinute;

                if (level === 1) {
                    distractorMinute = 0;
                } else {
                    distractorMinute = Math.floor(Math.random() * 12) * 5;
                }

                const distractorTimeStr = `${distractorHour}時${distractorMinute}分`;
                if (distractorTimeStr !== correctTimeStr) {
                    options.add(distractorTimeStr);
                }
            }

            const shuffledOptions = Array.from(options).sort(() => Math.random() - 0.5);

            answerOptionsEl.innerHTML = '';
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('px-4', 'py-2', 'rounded-lg', 'bg-blue-200', 'hover:bg-blue-300', 'transition', 'duration-200');
                button.addEventListener('click', () => checkAnswer(option));
                answerOptionsEl.appendChild(button);
            });
        }

        // レベル1と2の回答をチェック
        function checkAnswer(selectedTime) {
            const correctTimeStr = `${targetTime.hour}時${targetTime.minute}分`;
            if (selectedTime === correctTimeStr) {
                feedbackEl.textContent = '正解です！';
                feedbackEl.classList.add('correct');
                feedbackEl.classList.remove('incorrect');
            } else {
                feedbackEl.textContent = `不正解です。正解は ${correctTimeStr} でした。`;
                feedbackEl.classList.add('incorrect');
                feedbackEl.classList.remove('correct');
            }
            answerOptionsEl.style.display = 'none';
            nextRoundBtn.style.display = 'block';
        }

        // レベル3の回答をチェック
        function checkLevel3Answer() {
            if (currentHour === targetTime.hour && currentMinute === targetTime.minute) {
                feedbackEl.textContent = '正解です！';
                feedbackEl.classList.add('correct');
                feedbackEl.classList.remove('incorrect');
            } else {
                feedbackEl.textContent = `不正解です。正解は ${targetTime.hour}時${targetTime.minute}分 でした。`;
                feedbackEl.classList.add('incorrect');
                feedbackEl.classList.remove('correct');
            }
            submitBtn.style.display = 'none';
            nextRoundBtn.style.display = 'block';
        }

        // 次の問題に進む
        nextRoundBtn.addEventListener('click', () => {
            startGame(level);
            answerOptionsEl.style.display = 'flex';
        });
        
        // レベル3の回答ボタンのイベントリスナー
        submitBtn.addEventListener('click', checkLevel3Answer);

        // 時計を描画
        function drawClock(hour, minute) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 時計の文字盤
            ctx.beginPath();
            ctx.arc(clockCenterX, clockCenterY, clockRadius, 0, 2 * Math.PI);
            ctx.fillStyle = '#fff';
            ctx.fill();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            // 数字を描画
            ctx.font = '20px Noto Sans JP';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#333';
            for (let i = 1; i <= 12; i++) {
                const angle = (i - 3) * (Math.PI / 6);
                const x = clockCenterX + clockRadius * 0.85 * Math.cos(angle);
                const y = clockCenterY + clockRadius * 0.85 * Math.sin(angle);
                ctx.fillText(i, x, y);
            }

            // 時針
            const hourAngle = ((hour % 12) + (minute / 60) - 3) * (Math.PI / 6);
            drawHand(hourAngle, clockRadius * 0.5, 6, '#333');

            // 分針
            const minuteAngle = (minute / 60 * 2 * Math.PI) - (Math.PI / 2);
            drawHand(minuteAngle, clockRadius * 0.7, 4, '#333');
            
            // 中心点
            ctx.beginPath();
            ctx.arc(clockCenterX, clockCenterY, 8, 0, 2 * Math.PI);
            ctx.fillStyle = '#3b82f6';
            ctx.fill();
        }

        // 針を描画するヘルパー関数
        function drawHand(angle, length, width, color) {
            ctx.beginPath();
            ctx.lineWidth = width;
            ctx.lineCap = 'round';
            ctx.strokeStyle = color;
            ctx.moveTo(clockCenterX, clockCenterY);
            ctx.lineTo(
                clockCenterX + length * Math.cos(angle),
                clockCenterY + length * Math.sin(angle)
            );
            ctx.stroke();
        }

        // レベル3の操作ハンドラ
        canvas.addEventListener('mousedown', (e) => {
            if (level !== 3) return;
            mouseIsDown = true;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const hourHandLength = clockRadius * 0.5;
            const minuteHandLength = clockRadius * 0.7;
            const distFromCenter = Math.sqrt(Math.pow(mouseX - clockCenterX, 2) + Math.pow(mouseY - clockCenterY, 2));

            // どの針を掴んでいるか判断
            if (distFromCenter < minuteHandLength) {
                const angle = Math.atan2(mouseY - clockCenterY, mouseX - clockCenterX) + Math.PI / 2;
                const minuteAngle = (currentMinute / 60 * 2 * Math.PI);
                const hourAngle = ((currentHour % 12) + (currentMinute / 60)) / 12 * 2 * Math.PI;

                // どの針がマウスに近いか判定
                const diffMin = Math.min(Math.abs(angle - minuteAngle), Math.abs(angle - minuteAngle + 2 * Math.PI), Math.abs(angle - minuteAngle - 2 * Math.PI));
                const diffHour = Math.min(Math.abs(angle - hourAngle), Math.abs(angle - hourAngle + 2 * Math.PI), Math.abs(angle - hourAngle - 2 * Math.PI));
                
                if (diffMin < diffHour) {
                    handBeingDragged = 'minute';
                } else {
                    handBeingDragged = 'hour';
                }
            } else {
                handBeingDragged = null;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!mouseIsDown || !handBeingDragged) return;

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            let angle = Math.atan2(mouseY - clockCenterY, mouseX - clockCenterX);
            if (angle < 0) {
                angle += 2 * Math.PI;
            }
            
            // 針の動きの感度を低くする
            if (handBeingDragged === 'minute') {
                const newMinute = Math.round((angle / (2 * Math.PI)) * 60 / 5) * 5;
                if (Math.abs(newMinute - currentMinute) >= handSensitivity) {
                    currentMinute = newMinute;
                    if (currentMinute === 60) currentMinute = 0;
                    currentHour = ((currentHour % 12) + Math.floor(newMinute / 60));
                }
            } else if (handBeingDragged === 'hour') {
                const newHour = Math.round((angle / (2 * Math.PI)) * 12);
                if (Math.abs(newHour - currentHour) >= handSensitivity) {
                    currentHour = newHour === 0 ? 12 : newHour;
                }
            }

            drawClock(currentHour, currentMinute);
        });

        canvas.addEventListener('mouseup', () => {
            if (level !== 3) return;
            mouseIsDown = false;
            handBeingDragged = null;
        });

        // ページロード時の初期描画
        window.onload = () => {
            drawClock(10, 10);
        };
    });
</script>

</body>
</html>
